# IPC
**Interprocess Communications**

## 参考书籍
Unix网络编程卷二：进程间通信  
functionSys.md是学习unp时，总结的常用的系统函数，这里复制过来，添加一些常用的函数。

内存映射I/O即MMIO，它是PCI规范的一部分，I/O设备被放置在内存空间而不是I/O空间。从处理器的角度看，内存映射I/O后系统设备访问起来和内存一样。这样访问AGP/PCI-E显卡上的帧缓存，BIOS，PCI设备就可以使用读写内存一样的汇编指令完成，简化了程序设计的难度和接口的复杂性。
设备控制器只是内存中的变量，在C语言中可以直接寻址

## Why 进程间通信
&emsp;程序设计思想：把应用程序设计为一组相互通信的小片段，比将其设计成为单个庞大的程序更好。

注：程序构建方法发展：  
1、设计一个庞大的程序：衡虚各部分为函数，函数之间通过**参数**,**返回值**，**全局变量**来交换信息。  
2、多个程序之间使用IPC进行通信，比如使用shell管道。  
3、多线程程序，线程之间使用IPC。

## 将要介绍的内容(4种IPC形式)

1、消息传递（管道、FIFO和消息队列）  
2、同步（互斥量、条件变量、读写锁、文件和记录锁、信号量）  
3、共享内存（匿名的和具名的）  
4、远程过程调用（Solaris的门和Sun RPC）

为了介绍上面的IPC使用了三个例子：  
1、文件服务器：客户向服务器发送一个路径名，服务器返回文件内容给客户。  
2、生产者-消费者：数据放到一个缓冲区，一方写，一方操作。  
3、序列号持续增1：一个或多个进程或线程，对一个共享的序列号持续增1.序列号可能在内存中或文件中。

## OS版本

&emsp;多数unix系统源于Berkeley或者System V，不过二者的差别由于Posix标准正在慢慢变小，差别主要存在于系统管理，因为POSIX还没有对系统管理作出规定。

&emsp;Posix的第一部分（Posix.1）：规定了系统应用程序接口（API）；  
&emsp;Posix的第二部分（Posix.2）：规定了Shell和实用程序  
&emsp;Posix的第三部分：系统管理（正在开发）
## 术语

持续性：各种类型的IPC的存在时间，有进程持续，内核持续和文件系统持续。在选择哪种IPC时，需要清除相应的IPC的持续性。

名字空间：对于一种给定的IPC类型，其可能的名字的集合。对于无亲缘关系的进程，使用某种类型的IPC时，需要IPC对象有某种形式的名字或标识符。如管道没有名字，不支持无亲缘关系通信；有名管道支持。

## IPC名字

### Posix IPC
&emsp;要求以斜杠符开头，此时才能保证打开相同的队列。如果不以斜杠符开头，或者有多个斜杠符时怎么解释都取决于实现。为了移植性，一般将IPC名字用#define定义在一个容易修改的头文件中。  
* 对于Digital Unix直接使用路径名，如/tmp/test1，但是需要事先创建好/tmp/test1文件  
* 对于Solaris，使用一个斜杠符开头的，如/test2，Solaris会在/tmp目录下创建若干文件。

&emsp;消息队列创建时指定权限，这需要进程拥有对路径的对应权限，同时受到umask的调整，umask设置为1的，即使mode指定也不会有相应权限。如果没有权限，创建函数会置errno，可以查询对应错误就是无权限。  
消息队列对应的属主就是创建进程对应的用户ID及其组ID。
&emsp;指定创建模式，如果没有就创建，已有就返回对应描述符；也可以在有时报错。


### System V
&emsp;首先由路径名和id，由ftok（传递给ftok的路径必须是存在的）创建IPC键，msgget函数以IPC键或IP_PRIVATE为基础创建IPC标识符。标识符标识一个消息队列，标识符不特定于进程，而是特定于系统的，不同进程可以通过标识符访问消息队列。这里的标识符不用于Posix，是一个整数。  
&emsp;路径名参数；如果不存在或者对于调用调用进程不可访问，ftok返回-1,对应文件不能是服务器存活其间反复创建并删除的文件。  
&emsp;id参数：id的低序8位对应ftok返回值的低序8位，所以想获得的ftok返回值，可以设置id 不同。 

&emsp;权限和标识符已创建的问题和Posix是类似的。


## 编程

* 一般都将同步相关的结构放到一个结构体中。  
* 要注意使用unlink带来的后果，它对应的是删除底层支撑，会使得在这个名字基础上创建对象不返回已存在的错误，所以在进程中要注意unlink的使用。  
* 对于并发编程问题，不要从锁的角度分析。锁只是一种工具。首先分析这个问题如何解决，需要哪些必须共享的数据，然后将其组合到一个结构体中，并定义相应的锁与之配合。  
* 进程间的同步可以使用，Posix有名信号量，System V信号量；在共享内存区辅助下的互斥锁，条件变量，读写锁，Posix基于内存的信号量。  
* 共享内存区实现有 内存映射文件（需要创建文件）；匿名映射；共享变量对象。
